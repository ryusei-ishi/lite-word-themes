<?php
/**
 * LiteWord SEO - サイトマップ設定管理クラス（調整版）
 */

if ( ! defined( 'ABSPATH' ) ) exit;

class LW_Sitemap_Settings {
    
    const OPTION_KEY = 'lw_sitemap_settings';
    
    /**
     * デフォルト設定（不要な項目を削除）
     */
    public static function get_defaults() {
        return [
            // 更新頻度設定
            'changefreq' => [
                'homepage' => 'daily',
                'post' => 'weekly',
                'page' => 'monthly',
                'category' => 'weekly',
                'post_tag' => 'monthly',
                'author' => 'yearly'
            ],
            
            // 優先度設定
            'priority' => [
                'homepage' => '1.0',
                'post' => '0.8',
                'page' => '0.6',
                'category' => '0.5',
                'post_tag' => '0.3',
                'author' => '0.3'
            ],
            
            // 除外設定（最小画像数を削除）
            'exclude' => [
                'post_formats' => [],
                'post_types' => [],
                'exclude_media' => true,
                'exclude_password' => true
            ],
            
            // 画像サイトマップ
            'images' => [
                'include_images' => true,
                'include_featured' => true,
                'include_captions' => true
            ],
            
            // 通知設定
            'ping' => [
                'google_ping' => true,
                'bing_ping' => true,
                'auto_ping' => true,
                'ping_on_publish' => true
            ],
            
            // キャッシュ設定
            'cache' => [
                'enable_cache' => true,
                'cache_lifetime' => 86400, // 24時間
                'auto_regenerate' => true
            ],
            
            // 高度な設定（custom_urlsを削除）
            'advanced' => [
                'add_to_robots' => true,
                'enable_xsl' => true,
                'include_lastmod' => true
            ],
            // llms.txt設定を追加
            'llms' => [
                'enable_llms_txt' => true,
                'allow_ai_crawling' => true,
                'allowed_agents' => [
                    'GPTBot' => true,
                    'ChatGPT-User' => true,
                    'CCBot' => true,
                    'anthropic-ai' => true,
                    'Claude-Web' => true,
                ],
                'disallowed_paths' => [
                    '/wp-admin/',
                    '/wp-includes/',
                    '/wp-content/uploads/',
                ],
                'crawl_delay' => 1,
                'custom_rules' => '',
                'sitemap_reference' => true,
            ]
        ];
    }
    
    /**
     * llms.txtファイルを生成
     */
    public static function generate_llms_txt() {
        $settings = self::get_settings();
        $llms_settings = $settings['llms'];
        
        if (!$llms_settings['enable_llms_txt']) {
            return false;
        }
        
        $content = "# llms.txt - AI/LLM Crawler Guidelines\n";
        $content .= "# Generated by LiteWord SEO\n";
        $content .= "# Last updated: " . date('Y-m-d H:i:s') . "\n\n";
        
        // 全体的な許可/拒否設定
        if (!$llms_settings['allow_ai_crawling']) {
            // AI クローリングを全面的に拒否
            $content .= "# AI crawling is disallowed\n";
            $content .= "User-agent: *\n";
            $content .= "Disallow: /\n\n";
        } else {
            // エージェントごとの設定
            foreach ($llms_settings['allowed_agents'] as $agent => $allowed) {
                $content .= "User-agent: {$agent}\n";
                
                if ($allowed) {
                    $content .= "Allow: /\n";
                    
                    // 除外パスの設定
                    foreach ($llms_settings['disallowed_paths'] as $path) {
                        $content .= "Disallow: {$path}\n";
                    }
                    
                    // クロール遅延
                    if ($llms_settings['crawl_delay'] > 0) {
                        $content .= "Crawl-delay: {$llms_settings['crawl_delay']}\n";
                    }
                } else {
                    $content .= "Disallow: /\n";
                }
                
                $content .= "\n";
            }
        }
        
        // サイトマップ参照
        if ($llms_settings['sitemap_reference']) {
            $content .= "# Sitemap reference\n";
            $content .= "Sitemap: " . home_url('/wp-sitemap.xml') . "\n\n";
        }
        
        // カスタムルール
        if (!empty($llms_settings['custom_rules'])) {
            $content .= "# Custom rules\n";
            $content .= $llms_settings['custom_rules'] . "\n";
        }
        
        // ファイルに書き込み
        $file_path = ABSPATH . 'llms.txt';
        $result = file_put_contents($file_path, $content);
        
        return $result !== false;
    }
    
    /**
     * プレビュー用llms.txt生成（設定を直接受け取る）
     */
    public static function generate_llms_txt_preview($settings) {
        $llms_settings = $settings;
        
        $content = "# llms.txt - AI/LLM Crawler Guidelines\n";
        $content .= "# Generated by LiteWord SEO\n";
        $content .= "# Preview Mode\n\n";
        
        // 全体的な許可/拒否設定
        if (!$llms_settings['allow_ai_crawling']) {
            $content .= "# AI crawling is disallowed\n";
            $content .= "User-agent: *\n";
            $content .= "Disallow: /\n\n";
        } else {
            // エージェントごとの設定
            foreach ($llms_settings['allowed_agents'] as $agent => $allowed) {
                $content .= "User-agent: {$agent}\n";
                
                if ($allowed) {
                    $content .= "Allow: /\n";
                    
                    // 除外パスの設定
                    if (!empty($llms_settings['disallowed_paths'])) {
                        foreach ($llms_settings['disallowed_paths'] as $path) {
                            $content .= "Disallow: {$path}\n";
                        }
                    }
                    
                    // クロール遅延
                    if (isset($llms_settings['crawl_delay']) && $llms_settings['crawl_delay'] > 0) {
                        $content .= "Crawl-delay: {$llms_settings['crawl_delay']}\n";
                    }
                } else {
                    $content .= "Disallow: /\n";
                }
                
                $content .= "\n";
            }
        }
        
        // サイトマップ参照
        if (!empty($llms_settings['sitemap_reference'])) {
            $content .= "# Sitemap reference\n";
            $content .= "Sitemap: " . home_url('/wp-sitemap.xml') . "\n\n";
        }
        
        // カスタムルール
        if (!empty($llms_settings['custom_rules'])) {
            $content .= "# Custom rules\n";
            $content .= $llms_settings['custom_rules'] . "\n";
        }
        
        return $content;
    }
    
    /**
     * 設定からllms.txtファイルを生成
     */
    public static function generate_llms_txt_from_settings($settings) {
        $llms_settings = $settings;
        
        $content = "# llms.txt - AI/LLM Crawler Guidelines\n";
        $content .= "# Generated by LiteWord SEO\n";
        $content .= "# Last updated: " . date('Y-m-d H:i:s') . "\n\n";
        
        // 全体的な許可/拒否設定
        if (!$llms_settings['allow_ai_crawling']) {
            $content .= "# AI crawling is disallowed\n";
            $content .= "User-agent: *\n";
            $content .= "Disallow: /\n\n";
        } else {
            // エージェントごとの設定
            foreach ($llms_settings['allowed_agents'] as $agent => $allowed) {
                $content .= "User-agent: {$agent}\n";
                
                if ($allowed) {
                    $content .= "Allow: /\n";
                    
                    // 除外パスの設定
                    if (!empty($llms_settings['disallowed_paths'])) {
                        foreach ($llms_settings['disallowed_paths'] as $path) {
                            $content .= "Disallow: {$path}\n";
                        }
                    }
                    
                    // クロール遅延
                    if (isset($llms_settings['crawl_delay']) && $llms_settings['crawl_delay'] > 0) {
                        $content .= "Crawl-delay: {$llms_settings['crawl_delay']}\n";
                    }
                } else {
                    $content .= "Disallow: /\n";
                }
                
                $content .= "\n";
            }
        }
        
        // サイトマップ参照
        if (!empty($llms_settings['sitemap_reference'])) {
            $content .= "# Sitemap reference\n";
            $content .= "Sitemap: " . home_url('/wp-sitemap.xml') . "\n\n";
        }
        
        // カスタムルール
        if (!empty($llms_settings['custom_rules'])) {
            $content .= "# Custom rules\n";
            $content .= $llms_settings['custom_rules'] . "\n";
        }
        
        // ファイルに書き込み
        $file_path = ABSPATH . 'llms.txt';
        $result = file_put_contents($file_path, $content);
        
        return $result !== false;
    }
    
    /**
     * 設定を取得
     */
    public static function get_settings() {
        $settings = get_option( self::OPTION_KEY, [] );
        return wp_parse_args( $settings, self::get_defaults() );
    }
    
    /**
     * 設定を保存
     */
    public static function save_settings( $settings ) {
        $defaults = self::get_defaults();
        $settings = wp_parse_args( $settings, $defaults );
        update_option( self::OPTION_KEY, $settings );
        
        // キャッシュクリア
        self::clear_cache();
        
        return true;
    }
    
    /**
     * キャッシュクリア
     */
    public static function clear_cache() {
        delete_transient( 'lw_sitemap_cache' );
        delete_transient( 'lw_sitemap_index_cache' );
        
        // 各投稿タイプのキャッシュもクリア
        $post_types = get_post_types( ['public' => true] );
        foreach ( $post_types as $post_type ) {
            delete_transient( 'lw_sitemap_' . $post_type . '_cache' );
        }
    }
    
    /**
     * Ping送信（修正版:正しいサイトマップURL）
     */
    public static function send_ping( $sitemap_url = null ) {
        if ( ! $sitemap_url ) {
            $sitemap_url = home_url( '/wp-sitemap.xml' );
        }
        
        $settings = self::get_settings();
        $results = [];
        
        // Google Ping
        if ( $settings['ping']['google_ping'] ) {
            $google_url = 'https://www.google.com/ping?sitemap=' . urlencode( $sitemap_url );
            $response = wp_remote_get( $google_url );
            $results['google'] = ! is_wp_error( $response );
        }
        
        // Bing Ping  
        if ( $settings['ping']['bing_ping'] ) {
            $bing_url = 'https://www.bing.com/ping?sitemap=' . urlencode( $sitemap_url );
            $response = wp_remote_get( $bing_url );
            $results['bing'] = ! is_wp_error( $response );
        }
        
        return $results;
    }
}