/* ----------------------------------------------------------
 * LiteWord – 会社概要ブロック 01 (wdl/lw-company-1)
 * ----------------------------------------------------------
 * ■ 追加機能
 *   1. タイトル幅クラス（dt_width_l / m / s）を選択可
 *   2. フォントサイズクラス（font_size_l / m / s）を選択可
 *   3. dd の border-color をカラーピッカーで変更可
 * -------------------------------------------------------- */

import { registerBlockType } from '@wordpress/blocks';
import {
	RichText,
	InspectorControls,
	ColorPalette,
} from '@wordpress/block-editor';
import {
	PanelBody,
	SelectControl,
	RangeControl,
} from '@wordpress/components';
import { Fragment } from '@wordpress/element';
import { fontOptionsArr, fontWeightOptionsArr } from '../utils.js';
import './style.scss';
import './editor.scss';

/* -----------------------------------------------
   セレクトオプション
------------------------------------------------ */
const fontOptions       = fontOptionsArr();
const fontWeightOptions = fontWeightOptionsArr();

const widthClassOptions = [
	{ label: '幅 L', value: 'dt_width_l' },
	{ label: '幅 M', value: 'dt_width_m' },
	{ label: '幅 S', value: 'dt_width_s' },
];

const fontSizeOptions = [
	{ label: 'フォント L', value: 'font_size_l' },
	{ label: 'フォント M', value: 'font_size_m' },
	{ label: 'フォント S', value: 'font_size_s' },
];

/* -----------------------------------------------
   ブロック登録
------------------------------------------------ */
registerBlockType('wdl/lw-company-1', {
	title   : '会社概要 01',
	icon    : 'building',
	category: 'liteword-other',
	supports: { anchor: true },

	/* ---------- 属性 ---------- */
	attributes: {
		ulMaxWidth   : { type: 'number', default: 1600 },

		colorDt      : { type: 'string', default: '#111' },
		fontDt       : { type: 'string', default: '' },
		fontWeightDt : { type: 'string', default: '' },

		colorDd      : { type: 'string', default: '#111' },
		fontDd       : { type: 'string', default: '' },
		fontWeightDd : { type: 'string', default: '' },

		dtWidthClass : { type: 'string', default: 'dt_width_m' },
		fontSizeClass: { type: 'string', default: 'font_size_m' },
		ddBorderColor: { type: 'string', default: '#ddd' },

		contents: {
			type    : 'array',
			source  : 'query',
			selector: '.lw-company-1__dl',
			query   : {
				title: {
					type    : 'string',
					source  : 'html',
					selector: 'dt',
				},
				text: {
					type    : 'string',
					source  : 'html',
					selector: 'dd',
				},
			},
			default: [
				{ title: '社名',       text: '株式会社サンプル' },
				{ title: '設立',       text: '2000年4月1日' },
				{ title: '所在地',     text: '東京都新宿区西新宿1-1-1' },
				{ title: '代表者',     text: '代表取締役社長 山田太郎' },
				{ title: '資本金',     text: '1億円' },
				{ title: '従業員数',   text: '100名' },
				{ title: '事業内容',   text: 'ウェブサイト制作、システム開発、マーケティング支援' },
				{ title: '取引銀行',   text: 'みずほ銀行 新宿支店' },
				{ title: '主要取引先', text: '株式会社○○、株式会社△△、株式会社□□' },
				{ title: '連絡先',     text: 'TEL: 03-1234-5678 / FAX: 03-1234-5679' },
				{ title: 'URL',       text: 'https://www.sample.co.jp' },
			],
		},
	},

	/* ---------- エディター ---------- */
	edit({ attributes, setAttributes }) {
		const {
			ulMaxWidth,
			colorDt, fontDt, fontWeightDt,
			colorDd, fontDd, fontWeightDd,
			dtWidthClass, fontSizeClass, ddBorderColor,
			contents,
		} = attributes;

		/* --- 追加・削除・更新 --- */
		const addContent = () => {
			setAttributes({
				contents: [...contents, { title: '新しいタイトル', text: '新しいテキスト' }],
			});
		};

		const removeContent = (idx) => {
			setAttributes({ contents: contents.filter((_, i) => i !== idx) });
		};

		const updateContent = (idx, key, val) => {
			const list = [...contents];
			list[idx][key] = val;
			setAttributes({ contents: list });
		};

		/* --- JSX --- */
		return (
			<Fragment>
				<InspectorControls>
					{/* dt 設定 */}
					<PanelBody title="タイトル (dt)" initialOpen={false}>
						<p>文字色</p>
						<ColorPalette
							value={colorDt}
							onChange={(v)=> setAttributes({ colorDt: v })}
						/>
						<SelectControl
							label="フォント"
							value={fontDt}
							options={fontOptions}
							onChange={(v)=> setAttributes({ fontDt: v })}
						/>
						<SelectControl
							label="太さ"
							value={fontWeightDt}
							options={fontWeightOptions}
							onChange={(v)=> setAttributes({ fontWeightDt: v })}
						/>
						<SelectControl
							label="タイトル幅サイズ"
							value={dtWidthClass}
							options={widthClassOptions}
							onChange={(v)=> setAttributes({ dtWidthClass: v })}
						/>
					</PanelBody>

					{/* dd 設定 */}
					<PanelBody title="テキスト (dd)" initialOpen={false}>
						<p>文字色</p>
						<ColorPalette
							value={colorDd}
							onChange={(v)=> setAttributes({ colorDd: v })}
						/>
						<SelectControl
							label="フォント"
							value={fontDd}
							options={fontOptions}
							onChange={(v)=> setAttributes({ fontDd: v })}
						/>
						<SelectControl
							label="太さ"
							value={fontWeightDd}
							options={fontWeightOptions}
							onChange={(v)=> setAttributes({ fontWeightDd: v })}
						/>
						<p>dd 枠線色</p>
						<ColorPalette
							value={ddBorderColor}
							onChange={(v)=> setAttributes({ ddBorderColor: v })}
						/>
					</PanelBody>

					{/* 全体レイアウト */}
					<PanelBody title="全体レイアウト" initialOpen={true}>
						<RangeControl
							label="最大横幅"
							value={ulMaxWidth}
							onChange={(v)=> setAttributes({ ulMaxWidth: v })}
							min={600}
							max={1600}
						/>
						<SelectControl
							label="フォントサイズ"
							value={fontSizeClass}
							options={fontSizeOptions}
							onChange={(v)=> setAttributes({ fontSizeClass: v })}
						/>
					</PanelBody>
				</InspectorControls>

				{/* ビジュアル */}
				<div className="lw-company-1">
					<div
						className="lw-company-1__inner"
						style={{ maxWidth: ulMaxWidth }}
					>
						{contents.map((c, i) => (
							<dl
								key={i}
								className={`lw-company-1__dl ${dtWidthClass} ${fontSizeClass}`}
							>
								<RichText
									tagName="dt"
									value={c.title}
									onChange={(v)=> updateContent(i, 'title', v)}
									placeholder="タイトル"
									style={{ color: colorDt, fontWeight: fontWeightDt }}
									data-lw_font_set={fontDt}
								/>
								<RichText
									tagName="dd"
									value={c.text}
									onChange={(v)=> updateContent(i, 'text', v)}
									placeholder="テキスト"
									style={{
										color      : colorDd,
										fontWeight : fontWeightDd,
										borderColor: ddBorderColor,
									}}
									data-lw_font_set={fontDd}
								/>
								<button
									className="lw-company-1__remove_btn"
									onClick={()=> removeContent(i)}
								>
									削除
								</button>
							</dl>
						))}
					</div>
					<button
						className="lw-company-1__add_btn"
						onClick={addContent}
					>
						リストを追加する
					</button>
				</div>
			</Fragment>
		);
	},

	/* ---------- 保存 ---------- */
	save({ attributes }) {
		const {
			ulMaxWidth,
			colorDt, fontDt, fontWeightDt,
			colorDd, fontDd, fontWeightDd,
			dtWidthClass, fontSizeClass, ddBorderColor,
			contents,
		} = attributes;

		return (
			<div className="lw-company-1">
				<div
					className="lw-company-1__inner"
					style={{ maxWidth: ulMaxWidth }}
				>
					{contents.map((c, i) => (
						<dl
							key={i}
							className={`lw-company-1__dl ${dtWidthClass} ${fontSizeClass}`}
						>
							<RichText.Content
								tagName="dt"
								value={c.title}
								style={{ color: colorDt, fontWeight: fontWeightDt }}
								data-lw_font_set={fontDt}
							/>
							<RichText.Content
								tagName="dd"
								value={c.text}
								style={{
									color      : colorDd,
									fontWeight : fontWeightDd,
									borderColor: ddBorderColor,
								}}
								data-lw_font_set={fontDd}
							/>
						</dl>
					))}
				</div>
			</div>
		);
	},
});
